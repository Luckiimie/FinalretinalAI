<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCT Detection System - PWA</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="OCT Detection">
    <meta name="description" content="AI-Powered Retinal Disease Detection System">
    
    <!-- PWA Manifest -->
    <link rel="manifest" id="manifest-placeholder">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" sizes="180x180" id="apple-touch-icon">
    <link rel="icon" type="image/png" sizes="32x32" id="favicon-32">
    <link rel="icon" type="image/png" sizes="16x16" id="favicon-16">
    <link rel="mask-icon" id="safari-pinned-tab" color="#3b82f6">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styling */
        .main-header {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 3rem 2rem;
            border-radius: 16px;
            color: white;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            position: relative;
            overflow: hidden;
        }

        .main-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 3s infinite;
            pointer-events: none;
        }

        .main-header h1 {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            color: white;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .main-header p {
            font-size: 1.3rem;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 2rem;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            padding: 16px 24px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Sarabun', sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            color: rgba(255, 255, 255, 0.8);
            position: relative;
            overflow: hidden;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));
            color: white;
            box-shadow: 
                0 4px 15px rgba(255, 255, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
        }

        .nav-tab:hover:not(.active) {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.1));
            color: white;
        }

        .nav-tab-thick {
            font-weight: 700 !important;
            font-size: 1.05em;
        }

        /* Page Content */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        .card h3 {
            color: white;
            margin-bottom: 1rem;
            font-weight: 700;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .card p, .card div {
            color: rgba(255, 255, 255, 0.9);
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .status-ready {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .status-analyzing {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 12px;
            padding: 1rem 2rem;
            font-weight: 600;
            font-family: 'Sarabun', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
            overflow: hidden;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .btn:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.3));
            transform: translateY(-2px);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        .btn-success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.8), rgba(5, 150, 105, 0.6));
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.9), rgba(5, 150, 105, 0.7));
        }

        .btn-danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.8), rgba(220, 38, 38, 0.6));
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.7));
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 16px;
            padding: 3rem;
            text-align: center;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            cursor: pointer;
            color: white;
        }

        .upload-area:hover {
            border-color: rgba(255, 255, 255, 0.8);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
        }

        /* Results */
        .result-card {
            padding: 1.5rem;
            border-radius: 16px;
            margin: 1rem 0;
        }

        .cnv-detected {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.1));
            border-left: 4px solid #ef4444;
            color: white;
        }

        .normal-result {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.1));
            border-left: 4px solid #10b981;
            color: white;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 1.5rem;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            color: white;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-family: 'Sarabun', sans-serif;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Progress Bar */
        .progress-container {
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-bar {
            height: 8px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        /* Login Page */
        .login-container {
            max-width: 400px;
            margin: 2rem auto;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(20px);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }

        .login-container h2 {
            color: white;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* History */
        .history-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        .history-item:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));
        }

        /* Confirm Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.85));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
        }

        .modal h3 {
            color: #1f2937;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .modal p {
            color: #6b7280;
            font-size: 1.1rem;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .modal-btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-family: 'Sarabun', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .modal-btn-cancel {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .modal-btn-cancel:hover {
            background: linear-gradient(135deg, #e5e7eb, #d1d5db);
            transform: translateY(-1px);
        }

        .modal-btn-confirm {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .modal-btn-confirm:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        /* Success Message */
        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
            z-index: 1001;
            animation: slideInRight 0.4s ease;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .fade-in {
            animation: fadeIn 0.6s ease;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .main-header h1 {
                font-size: 2.5rem;
            }

            .nav-tabs {
                flex-wrap: wrap;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .modal {
                width: 95%;
                padding: 1.5rem;
            }
        }

        /* PWA Install Button */
        .install-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 20px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
            display: none;
            z-index: 1000;
        }

        .install-btn:hover {
            transform: scale(1.05);
        }

        /* Offline Indicator */
        .offline-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ef4444;
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-weight: 600;
            display: none;
            z-index: 1000;
        }

        .online-indicator {
            background: #10b981;
        }
    </style>
</head>
<body>
    <!-- PWA Install Button -->
    <button id="installBtn" class="install-btn">üì± ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ</button>
    
    <!-- Offline Indicator -->
    <div id="offlineIndicator" class="offline-indicator">üî¥ ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå</div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal">
            <h3>‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h3>
            <p>‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?<br>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</p>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="hideConfirmModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmClearHistory()">‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
        </div>
    </div>

    <!-- Analysis Confirm Modal -->
    <div id="analysisConfirmModal" class="modal-overlay">
        <div class="modal">
            <h3>‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h3>
            <div id="confirmPatientData" style="text-align: left; margin: 1.5rem 0; background: rgba(59, 130, 246, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">
                <!-- Patient data will be populated here -->
            </div>
            <p style="color: #6b7280; margin-bottom: 2rem;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</p>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="hideAnalysisConfirmModal()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmStartAnalysis()" style="background: linear-gradient(135deg, #10b981, #059669);">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
            </div>
        </div>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="success-message">
        ‚úÖ ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!
    </div>

    <div class="container">
        <!-- Login Page -->
        <div id="loginPage" class="page active">
            <div class="main-header">
                <h1>üëÅÔ∏è OCT Detection System</h1>
                <p>AI-Powered Retinal Disease Detection System</p>
            </div>
            
            <div class="login-container">
                <h2 style="text-align: center; margin-bottom: 1.5rem;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-input" placeholder="doctor" value="doctor">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-input" placeholder="123456" value="123456">
                </div>
                
                <button onclick="login()" class="btn" style="width: 100%; margin-bottom: 1rem;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                
                <div style="background: #dbeafe; padding: 1rem; border-radius: 8px; text-align: center;">
                    <small><strong>Demo:</strong> username: doctor, password: 123456</small>
                </div>
            </div>
        </div>

        <!-- Main App -->
        <div id="mainApp" class="page">
            <!-- Header -->
            <div class="main-header">
                <h1>üëÅÔ∏è OCT Detection System</h1>
                <p>AI-Powered Retinal Disease Detection ‚Ä¢ Dashboard</p>
            </div>

            <!-- Navigation -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div class="nav-tabs" style="margin-bottom: 0;">
                    <button class="nav-tab active" onclick="showPage('dashboard')">üìä Dashboard</button>
                    <button class="nav-tab nav-tab-thick" onclick="showPage('newAnalysis')">üìÅ New Analysis</button>
                    <button class="nav-tab" onclick="showPage('patientHistory')">üîç Patient History Search</button>
                </div>
                <button onclick="logout()" class="btn btn-danger" style="padding: 0.75rem 1.5rem; font-size: 0.9rem;">
                    üö™ Logout
                </button>
            </div>

            <!-- Dashboard Page -->
            <div id="dashboardPage" class="tab-content active">
                <!-- Statistics Section -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalAnalyses">0</div>
                        <div>üìä Total Analyses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="cnvDetected">0</div>
                        <div>‚ö†Ô∏è Disease Detected</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="normalResults">0</div>
                        <div>‚úÖ Normal Results</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgConfidence">0%</div>
                        <div>üéØ Avg Confidence</div>
                    </div>
                </div>

                <!-- Recent Analyses Section -->
                <div class="card">
                    <h3>üìã Recent Analyses</h3>
                    <div id="recentAnalyses">
                        <p style="text-align: center; color: rgba(255,255,255,0.7); padding: 2rem;">
                            üìä No recent analyses available
                        </p>
                    </div>
                </div>

                <!-- Analysis History Section -->
                <div class="card">
                    <h3>üìä Analysis History</h3>
                    <div id="analysisHistoryList">
                        <p style="text-align: center; color: rgba(255,255,255,0.7); padding: 2rem;">
                            üìà Analysis history will appear here
                        </p>
                    </div>
                </div>
            </div>

            <!-- New Analysis Page -->
            <div id="newAnalysisPage" class="tab-content">
                <!-- Upload OCT Image Section -->
                <div id="uploadSection" class="card">
                    <h3>üìÅ Upload OCT Image</h3>
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìÅ</div>
                        <h4>Click to upload or drag & drop</h4>
                        <p>Supported formats: JPG, PNG, DICOM</p>
                        <p style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Maximum file size: 10MB</p>
                    </div>
                    <input type="file" id="fileInput" accept="image/*,.dcm" style="display: none;" onchange="handleFileSelect(event)">
                </div>

                <!-- Patient Information Form -->
                <div id="patientInfoForm" class="card">
                    <h3>üìã Patient Information</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label" style="color: white;">‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ *</label>
                            <input type="text" id="patientId" class="form-input" placeholder="P12345" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white;" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" style="color: white;">‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤ *</label>
                            <select id="eyeSide" class="form-input" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white;" required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤</option>
                                <option value="OD">OD (‡∏ï‡∏≤‡∏Ç‡∏ß‡∏≤)</option>
                                <option value="OS">OS (‡∏ï‡∏≤‡∏ã‡πâ‡∏≤‡∏¢)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" style="color: white;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à *</label>
                            <input type="date" id="examDate" class="form-input" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white;" required>
                        </div>
                    </div>
                    
                    <button onclick="submitPatientInfo()" class="btn" style="width: 100%; margin-top: 1.5rem; padding: 1.2rem 2rem; font-size: 1.1rem; font-weight: 700;">
                        üìù Submit
                    </button>
                </div>

                <!-- Analysis Progress -->
                <div id="analysisProgress" class="card" style="display: none;">
                    <div class="status-indicator status-analyzing">
                        <span>üü°</span>
                        <span>Analyzing Image...</span>
                    </div>
                    <h3>ü§ñ AI is analyzing your OCT image...</h3>
                    <div class="progress-container">
                        <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                    </div>
                    <p id="progressText" style="text-align: center;">üîç Analyzing... 0%</p>
                </div>

                <!-- Analysis Results -->
                <div id="analysisResults" class="card" style="display: none;">
                    <!-- Results will be populated here -->
                </div>
            </div>

            <!-- Patient History Search Page -->
            <div id="patientHistoryPage" class="tab-content">
                <!-- Search & Filter Section -->
                <div class="card">
                    <h3>üîç Search & Filter</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label class="form-label" style="color: white;">Patient ID</label>
                            <input type="text" id="searchPatientId" class="form-input" placeholder="P12345" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white;">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" style="color: white;">Date Range</label>
                            <input type="date" id="searchDateFrom" class="form-input" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white;">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" style="color: white;">Result Type</label>
                            <select id="searchResultType" class="form-input" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white;">
                                <option value="">All Results</option>
                                <option value="cnv">CNV Detected</option>
                                <option value="normal">Normal</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button onclick="filterHistory()" class="btn" style="flex: 1;">üîç Search</button>
                        <button onclick="clearHistory()" class="btn btn-danger">üóëÔ∏è Clear All History</button>
                    </div>
                </div>

                <!-- Search Results Section -->
                <div id="searchResults" class="card">
                    <h3>üìä Search Results</h3>
                    <div id="historyResults">
                        <p style="text-align: center; color: rgba(255,255,255,0.7); padding: 2rem;">
                            üîç Use the search filters above to find analysis results.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // PWA and App State
        let deferredPrompt;
        let analysisHistory = JSON.parse(localStorage.getItem('octAnalysisHistory') || '[]');
        let currentAnalysis = null;

        // PWA Installation
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').style.display = 'block';
        });

        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('installBtn').style.display = 'none';
                }
                deferredPrompt = null;
            }
        });

        // PWA Setup and Service Worker Registration
        function setupPWA() {
            // Create manifest
            const manifest = {
                name: "OCT Detection System - AI-Powered Retinal Analysis",
                short_name: "OCT Analysis",
                description: "AI-Powered Retinal Disease Detection System for Medical Professionals",
                start_url: "./",
                display: "standalone",
                background_color: "#667eea",
                theme_color: "#3b82f6",
                orientation: "portrait-primary",
                scope: "./",
                lang: "th",
                categories: ["medical", "health", "productivity"],
                icons: [
                    {
                        src: generateIcon(72),
                        sizes: "72x72",
                        type: "image/png",
                        purpose: "any maskable"
                    },
                    {
                        src: generateIcon(96),
                        sizes: "96x96", 
                        type: "image/png",
                        purpose: "any maskable"
                    },
                    {
                        src: generateIcon(128),
                        sizes: "128x128",
                        type: "image/png",
                        purpose: "any maskable"
                    },
                    {
                        src: generateIcon(144),
                        sizes: "144x144",
                        type: "image/png",
                        purpose: "any maskable"
                    },
                    {
                        src: generateIcon(152),
                        sizes: "152x152",
                        type: "image/png",
                        purpose: "any maskable"
                    },
                    {
                        src: generateIcon(192),
                        sizes: "192x192",
                        type: "image/png",
                        purpose: "any maskable"
                    },
                    {
                        src: generateIcon(384),
                        sizes: "384x384",
                        type: "image/png",
                        purpose: "any maskable"
                    },
                    {
                        src: generateIcon(512),
                        sizes: "512x512",
                        type: "image/png",
                        purpose: "any maskable"
                    }
                ],
                shortcuts: [
                    {
                        name: "New Analysis",
                        short_name: "Analyze",
                        description: "Start a new OCT image analysis",
                        url: "./?page=newAnalysis",
                        icons: [{ src: generateIcon(96), sizes: "96x96" }]
                    },
                    {
                        name: "Patient History",
                        short_name: "History", 
                        description: "Search patient analysis history",
                        url: "./?page=patientHistory",
                        icons: [{ src: generateIcon(96), sizes: "96x96" }]
                    }
                ]
            };

            // Set manifest
            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestURL = URL.createObjectURL(manifestBlob);
            document.getElementById('manifest-placeholder').href = manifestURL;

            // Set icons
            document.getElementById('apple-touch-icon').href = generateIcon(180);
            document.getElementById('favicon-32').href = generateIcon(32);
            document.getElementById('favicon-16').href = generateIcon(16);
            document.getElementById('safari-pinned-tab').href = generateIcon(180);
        }

        function generateIcon(size) {
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');

            // Create gradient background
            const gradient = ctx.createLinearGradient(0, 0, size, size);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(1, '#764ba2');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, size, size);

            // Add eye icon
            ctx.fillStyle = 'white';
            ctx.font = `${size * 0.5}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('üëÅÔ∏è', size / 2, size / 2);

            return canvas.toDataURL('image/png');
        }

        // Advanced Service Worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                const swCode = `
                    const CACHE_NAME = 'oct-analysis-v2.1';
                    const STATIC_CACHE = 'oct-static-v2.1';
                    const DYNAMIC_CACHE = 'oct-dynamic-v2.1';
                    
                    const STATIC_FILES = [
                        './',
                        './index.html',
                        'https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap'
                    ];

                    // Install event
                    self.addEventListener('install', (event) => {
                        console.log('[SW] Installing...');
                        event.waitUntil(
                            caches.open(STATIC_CACHE)
                                .then((cache) => {
                                    console.log('[SW] Caching static files');
                                    return cache.addAll(STATIC_FILES);
                                })
                                .then(() => {
                                    console.log('[SW] Skip waiting');
                                    return self.skipWaiting();
                                })
                        );
                    });

                    // Activate event
                    self.addEventListener('activate', (event) => {
                        console.log('[SW] Activating...');
                        event.waitUntil(
                            caches.keys().then((cacheNames) => {
                                return Promise.all(
                                    cacheNames.map((cacheName) => {
                                        if (cacheName !== STATIC_CACHE && cacheName !== DYNAMIC_CACHE) {
                                            console.log('[SW] Deleting old cache:', cacheName);
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            }).then(() => {
                                console.log('[SW] Claiming clients');
                                return self.clients.claim();
                            })
                        );
                    });

                    // Fetch event with advanced caching strategies
                    self.addEventListener('fetch', (event) => {
                        const { request } = event;
                        const url = new URL(request.url);

                        // Handle different types of requests
                        if (request.method === 'GET') {
                            // Static files - Cache First
                            if (STATIC_FILES.includes(url.pathname) || url.pathname === '/') {
                                event.respondWith(cacheFirst(request));
                            }
                            // Google Fonts - Cache First
                            else if (url.origin === 'https://fonts.googleapis.com' || url.origin === 'https://fonts.gstatic.com') {
                                event.respondWith(cacheFirst(request));
                            }
                            // Other requests - Network First
                            else {
                                event.respondWith(networkFirst(request));
                            }
                        }
                    });

                    // Cache First Strategy
                    async function cacheFirst(request) {
                        try {
                            const cachedResponse = await caches.match(request);
                            if (cachedResponse) {
                                return cachedResponse;
                            }
                            
                            const networkResponse = await fetch(request);
                            if (networkResponse.ok) {
                                const cache = await caches.open(STATIC_CACHE);
                                cache.put(request, networkResponse.clone());
                            }
                            return networkResponse;
                        } catch (error) {
                            console.log('[SW] Cache first failed:', error);
                            return new Response('Offline - Content not available', {
                                status: 503,
                                statusText: 'Service Unavailable'
                            });
                        }
                    }

                    // Network First Strategy
                    async function networkFirst(request) {
                        try {
                            const networkResponse = await fetch(request);
                            if (networkResponse.ok) {
                                const cache = await caches.open(DYNAMIC_CACHE);
                                cache.put(request, networkResponse.clone());
                            }
                            return networkResponse;
                        } catch (error) {
                            console.log('[SW] Network first failed, trying cache:', error);
                            const cachedResponse = await caches.match(request);
                            if (cachedResponse) {
                                return cachedResponse;
                            }
                            return new Response('Offline - Content not available', {
                                status: 503,
                                statusText: 'Service Unavailable'
                            });
                        }
                    }

                    // Background sync for offline analysis queue
                    self.addEventListener('sync', (event) => {
                        if (event.tag === 'background-sync-analysis') {
                            event.waitUntil(processOfflineAnalysis());
                        }
                    });

                    async function processOfflineAnalysis() {
                        // Process queued analyses when back online
                        console.log('[SW] Processing offline analysis queue');
                        // Implementation would handle queued analysis requests
                    }

                    // Push notifications for analysis results
                    self.addEventListener('push', (event) => {
                        const options = {
                            body: event.data ? event.data.text() : 'Analysis complete',
                            icon: './icon-192x192.png',
                            badge: './icon-72x72.png',
                            vibrate: [200, 100, 200],
                            data: {
                                dateOfArrival: Date.now(),
                                primaryKey: 1
                            },
                            actions: [
                                {
                                    action: 'view',
                                    title: 'View Results',
                                    icon: './icon-96x96.png'
                                },
                                {
                                    action: 'close',
                                    title: 'Close',
                                    icon: './icon-96x96.png'
                                }
                            ]
                        };

                        event.waitUntil(
                            self.registration.showNotification('OCT Analysis Complete', options)
                        );
                    });

                    // Handle notification clicks
                    self.addEventListener('notificationclick', (event) => {
                        event.notification.close();

                        if (event.action === 'view') {
                            event.waitUntil(
                                clients.openWindow('./?page=dashboard')
                            );
                        }
                    });

                    // Periodic background sync
                    self.addEventListener('periodicsync', (event) => {
                        if (event.tag === 'update-analysis-data') {
                            event.waitUntil(updateAnalysisData());
                        }
                    });

                    async function updateAnalysisData() {
                        console.log('[SW] Updating analysis data in background');
                        // Implementation would sync with server
                    }
                `;

                const swBlob = new Blob([swCode], { type: 'application/javascript' });
                const swURL = URL.createObjectURL(swBlob);

                navigator.serviceWorker.register(swURL)
                    .then((registration) => {
                        console.log('‚úÖ Service Worker registered successfully:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showUpdateAvailable();
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.error('‚ùå Service Worker registration failed:', error);
                    });
            }
        }

        function showUpdateAvailable() {
            const updateBanner = document.createElement('div');
            updateBanner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 1rem;
                text-align: center;
                z-index: 10000;
                box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
            `;
            updateBanner.innerHTML = `
                <div>üîÑ New version available! <button onclick="location.reload()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 0.5rem 1rem; border-radius: 8px; margin-left: 1rem; cursor: pointer;">Update Now</button></div>
            `;
            document.body.insertBefore(updateBanner, document.body.firstChild);
        }

        // Online/Offline Status
        function updateOnlineStatus() {
            const indicator = document.getElementById('offlineIndicator');
            if (navigator.onLine) {
                indicator.style.display = 'none';
            } else {
                indicator.style.display = 'block';
                indicator.textContent = 'üî¥ ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå';
                indicator.className = 'offline-indicator';
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

        // Authentication
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === 'doctor' && password === '123456') {
                document.getElementById('loginPage').classList.remove('active');
                document.getElementById('mainApp').classList.add('active');
                updateDashboard();
            } else {
                alert('Invalid credentials. Use username: doctor, password: 123456');
            }
        }

        function logout() {
            document.getElementById('mainApp').classList.remove('active');
            document.getElementById('loginPage').classList.add('active');
            document.getElementById('username').value = 'doctor';
            document.getElementById('password').value = '123456';
        }

        // Navigation
        function showPage(pageName) {
            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update page content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(pageName + 'Page').classList.add('active');
            
            if (pageName === 'dashboard') {
                updateDashboard();
            } else if (pageName === 'patientHistory') {
                updateHistory();
            } else if (pageName === 'newAnalysis') {
                // Reset to ready state when clicking New Analysis
                newAnalysis();
            }
        }

        // Dashboard Functions
        function updateDashboard() {
            updateStatistics();
            updateRecentAnalyses();
            updateAnalysisHistory();
        }

        function updateStatistics() {
            const total = analysisHistory.length;
            const cnvCount = analysisHistory.filter(a => a.hasDetection).length;
            const normalCount = total - cnvCount;
            const avgConfidence = total > 0 ? 
                (analysisHistory.reduce((sum, a) => sum + a.confidence, 0) / total).toFixed(1) : 0;

            document.getElementById('totalAnalyses').textContent = total;
            document.getElementById('cnvDetected').textContent = cnvCount;
            document.getElementById('normalResults').textContent = normalCount;
            document.getElementById('avgConfidence').textContent = avgConfidence + '%';
        }

        function updateRecentAnalyses() {
            const container = document.getElementById('recentAnalyses');
            const recent = analysisHistory.slice(0, 5); // Show last 5 analyses
            
            if (recent.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.7); padding: 2rem;">üìä No recent analyses available</p>';
                return;
            }
            
            container.innerHTML = recent.map(analysis => `
                <div class="history-item" onclick="showAnalysisDetails('${analysis.id}')" style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${analysis.hasDetection ? '‚ö†Ô∏è' : '‚úÖ'} ${analysis.patientId} - ${analysis.eyeSide}</strong><br>
                            <small>Exam: ${new Date(analysis.examDate).toLocaleDateString('th-TH')} ‚Ä¢ Analysis: ${new Date(analysis.timestamp).toLocaleDateString('th-TH')}</small>
                        </div>
                        <div style="text-align: right;">
                            <span style="font-weight: bold; color: ${analysis.hasDetection ? '#dc2626' : '#059669'};">
                                ${analysis.hasDetection ? 'CNV Detected' : 'Normal'}
                            </span><br>
                            <small>${analysis.confidence.toFixed(1)}% confidence ‚Ä¢ ${analysis.riskLevel}</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateAnalysisHistory() {
            const container = document.getElementById('analysisHistoryList');
            
            if (analysisHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.7); padding: 2rem;">üìà Analysis history will appear here</p>';
                return;
            }
            
            container.innerHTML = analysisHistory.map(analysis => `
                <div class="history-item" onclick="showAnalysisDetails('${analysis.id}')" style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${analysis.hasDetection ? '‚ö†Ô∏è' : '‚úÖ'} ${analysis.patientId} - ${analysis.eyeSide}</strong><br>
                            <small>Exam: ${new Date(analysis.examDate).toLocaleDateString('th-TH')} ‚Ä¢ Analysis: ${new Date(analysis.timestamp).toLocaleDateString('th-TH')}</small>
                        </div>
                        <div style="text-align: right;">
                            <span style="font-weight: bold; color: ${analysis.hasDetection ? '#dc2626' : '#059669'};">
                                ${analysis.hasDetection ? 'CNV Detected' : 'Normal'}
                            </span><br>
                            <small>${analysis.confidence.toFixed(1)}% confidence ‚Ä¢ ${analysis.riskLevel}</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // File Upload Functions
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                displayImagePreview(file);
            }
        }

        function displayImagePreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // Store image data for analysis
                currentAnalysis = {
                    imageData: e.target.result,
                    fileName: file.name,
                    fileSize: file.size,
                    fileType: file.type
                };
                
                // Set today's date as default
                document.getElementById('examDate').value = new Date().toISOString().split('T')[0];
            };
            reader.readAsDataURL(file);
        }

        // Patient Information Functions
        function submitPatientInfo() {
            // Validate required fields
            const patientId = document.getElementById('patientId').value.trim();
            const eyeSide = document.getElementById('eyeSide').value;
            const examDate = document.getElementById('examDate').value;
            
            if (!patientId || !eyeSide || !examDate) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô\n\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô:\n- ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢\n- ‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤\n- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à');
                return;
            }
            
            // Show confirmation modal with patient data
            showAnalysisConfirmModal(patientId, eyeSide, examDate);
        }

        function showAnalysisConfirmModal(patientId, eyeSide, examDate) {
            const eyeSideText = eyeSide === 'OD' ? 'OD (‡∏ï‡∏≤‡∏Ç‡∏ß‡∏≤)' : 'OS (‡∏ï‡∏≤‡∏ã‡πâ‡∏≤‡∏¢)';
            const formattedDate = new Date(examDate).toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('confirmPatientData').innerHTML = `
                <div style="display: grid; gap: 0.75rem;">
                    <div><strong style="color: #1f2937;">‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</strong> <span style="color: #3b82f6; font-weight: 600;">${patientId}</span></div>
                    <div><strong style="color: #1f2937;">‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤:</strong> <span style="color: #3b82f6; font-weight: 600;">${eyeSideText}</span></div>
                    <div><strong style="color: #1f2937;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à:</strong> <span style="color: #3b82f6; font-weight: 600;">${formattedDate}</span></div>
                </div>
            `;
            
            document.getElementById('analysisConfirmModal').classList.add('show');
        }

        function hideAnalysisConfirmModal() {
            document.getElementById('analysisConfirmModal').classList.remove('show');
        }

        function confirmStartAnalysis() {
            hideAnalysisConfirmModal();
            startAnalysisWithOfflineSupport();
        }

        function startAnalysisWithOfflineSupport() {
            // Get patient data from form
            const patientId = document.getElementById('patientId').value.trim();
            const eyeSide = document.getElementById('eyeSide').value;
            const examDate = document.getElementById('examDate').value;
            
            // Show progress
            document.getElementById('analysisProgress').style.display = 'block';
            document.getElementById('patientInfoForm').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'none';
            
            // Simulate analysis progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress > 100) progress = 100;
                
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressText').textContent = `üîç Analyzing... ${Math.floor(progress)}%`;
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    setTimeout(() => {
                        completeAnalysisWithOfflineSupport(patientId, eyeSide, examDate);
                    }, 500);
                }
            }, 100);
        }

        // Drag and Drop
        const uploadArea = document.querySelector('.upload-area');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                displayImagePreview(files[0]);
            }
        });

        // Analysis Functions
        function startAnalysis() {
            // Get patient data from form
            const patientId = document.getElementById('patientId').value.trim();
            const eyeSide = document.getElementById('eyeSide').value;
            const examDate = document.getElementById('examDate').value;
            
            // Show progress
            document.getElementById('analysisProgress').style.display = 'block';
            document.getElementById('patientInfoForm').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'none';
            
            // Simulate analysis progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress > 100) progress = 100;
                
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressText').textContent = `üîç Analyzing... ${Math.floor(progress)}%`;
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    setTimeout(() => {
                        completeAnalysis(patientId, eyeSide, examDate);
                    }, 500);
                }
            }, 100);
        }

        function completeAnalysis(patientId, eyeSide, examDate) {
            // Generate random results
            const confidence = 70 + Math.random() * 30;
            const hasDetection = Math.random() > 0.3;
            
            const diseases = [
                'Choroidal Neovascularization (CNV)',
                'Diabetic Macular Edema',
                'Age-related Macular Degeneration',
                'Macular Hole',
                'Epiretinal Membrane'
            ];
            
            const result = {
                id: generateUUID(),
                patientId: patientId,
                eyeSide: eyeSide,
                examDate: examDate,
                timestamp: new Date().toISOString(),
                hasDetection: hasDetection,
                confidence: confidence,
                detectedDisease: hasDetection ? diseases[Math.floor(Math.random() * diseases.length)] : null,
                riskLevel: hasDetection && confidence > 85 ? 'High Risk' : hasDetection ? 'Medium Risk' : 'Low Risk',
                imageData: currentAnalysis ? currentAnalysis.imageData : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzMzMzMzMyIvPjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+T0NUIEltYWdlPC90ZXh0Pjwvc3ZnPg==',
                fileName: currentAnalysis ? currentAnalysis.fileName : 'oct_analysis.jpg'
            };
            
            // Save to history
            analysisHistory.unshift(result);
            localStorage.setItem('octAnalysisHistory', JSON.stringify(analysisHistory));
            
            // Hide all previous sections and show only results
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('patientInfoForm').style.display = 'none';
            document.getElementById('analysisProgress').style.display = 'none';
            document.getElementById('analysisResults').style.display = 'block';
            displayResults(result);
        }

        function displayResults(result) {
            const resultsContainer = document.getElementById('analysisResults');
            const resultClass = result.hasDetection ? 'cnv-detected' : 'normal-result';
            
            resultsContainer.innerHTML = `
                <h2>üìä Analysis Results</h2>
                
                <div class="result-card ${resultClass}">
                    <h3>${result.hasDetection ? '‚ö†Ô∏è CNV DETECTED' : '‚úÖ NORMAL RESULT'}</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0;">
                        <p><strong>Patient ID:</strong> ${result.patientId}</p>
                        <p><strong>Eye Side:</strong> ${result.eyeSide}</p>
                        <p><strong>Exam Date:</strong> ${new Date(result.examDate).toLocaleDateString('th-TH')}</p>
                    </div>
                    ${result.hasDetection ? `<p><strong>Disease:</strong> ${result.detectedDisease}</p>` : '<p><strong>Status:</strong> No abnormalities detected</p>'}
                    <p><strong>Risk Level:</strong> ${result.riskLevel}</p>
                    <p><strong>Confidence:</strong> ${result.confidence.toFixed(1)}%</p>
                </div>
                
                <div style="text-align: center; margin-top: 2rem;">
                    <button onclick="analyseMore()" class="btn" style="padding: 1.5rem 4rem; font-size: 1.2rem; font-weight: 700;">
                        üîÑ Analyze More
                    </button>
                </div>
            `;
        }

        // History Functions
        function updateHistory() {
            const container = document.getElementById('historyResults');
            container.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.7); padding: 2rem;">üîç Use the search filters above to find analysis results.</p>';
        }

        function filterHistory() {
            const patientId = document.getElementById('searchPatientId').value.toLowerCase();
            const dateFrom = document.getElementById('searchDateFrom').value;
            const resultType = document.getElementById('searchResultType').value;
            
            let filteredResults = analysisHistory;
            
            // Filter by patient ID
            if (patientId) {
                filteredResults = filteredResults.filter(analysis => 
                    analysis.patientId.toLowerCase().includes(patientId)
                );
            }
            
            // Filter by date
            if (dateFrom) {
                filteredResults = filteredResults.filter(analysis => 
                    analysis.examDate >= dateFrom
                );
            }
            
            // Filter by result type
            if (resultType === 'cnv') {
                filteredResults = filteredResults.filter(analysis => analysis.hasDetection);
            } else if (resultType === 'normal') {
                filteredResults = filteredResults.filter(analysis => !analysis.hasDetection);
            }
            
            // Display results
            const container = document.getElementById('historyResults');
            
            if (filteredResults.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.7); padding: 2rem;">‚ùå No results found matching your criteria.</p>';
                return;
            }
            
            container.innerHTML = filteredResults.map(analysis => `
                <div class="history-item" onclick="showAnalysisDetails('${analysis.id}')" style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${analysis.hasDetection ? '‚ö†Ô∏è' : '‚úÖ'} ${analysis.patientId} - ${analysis.eyeSide}</strong><br>
                            <small>Exam: ${new Date(analysis.examDate).toLocaleDateString('th-TH')} ‚Ä¢ Analysis: ${new Date(analysis.timestamp).toLocaleDateString('th-TH')}</small>
                        </div>
                        <div style="text-align: right;">
                            <span style="font-weight: bold; color: ${analysis.hasDetection ? '#dc2626' : '#059669'};">
                                ${analysis.hasDetection ? 'CNV Detected' : 'Normal'}
                            </span><br>
                            <small>${analysis.confidence.toFixed(1)}% confidence ‚Ä¢ ${analysis.riskLevel}</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showAnalysisDetails(analysisId) {
            const analysis = analysisHistory.find(a => a.id === analysisId);
            if (analysis) {
                // Switch to new analysis page and show results
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.nav-tab[onclick="showPage(\'newAnalysis\')"]').classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById('newAnalysisPage').classList.add('active');
                
                // Hide all sections except results
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('patientInfoForm').style.display = 'none';
                document.getElementById('analysisProgress').style.display = 'none';
                document.getElementById('analysisResults').style.display = 'block';
                displayResults(analysis);
            }
        }

        function clearHistory() {
            showConfirmModal();
        }

        function showConfirmModal() {
            document.getElementById('confirmModal').classList.add('show');
        }

        function hideConfirmModal() {
            document.getElementById('confirmModal').classList.remove('show');
        }

        function confirmClearHistory() {
            analysisHistory = [];
            localStorage.setItem('octAnalysisHistory', JSON.stringify(analysisHistory));
            updateDashboard();
            updateHistory();
            hideConfirmModal();
            showSuccessMessage();
        }

        function showSuccessMessage() {
            const successMsg = document.getElementById('successMessage');
            successMsg.classList.add('show');
            setTimeout(() => {
                successMsg.classList.remove('show');
            }, 3000);
        }

        // Utility Functions
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function downloadReport(analysisId) {
            const analysis = analysisHistory.find(a => a.id === analysisId);
            if (!analysis) return;
            
            const report = generateReport(analysis);
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `OCT_Analysis_Report_${analysis.patientId}_${new Date(analysis.timestamp).toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function generateReport(result) {
            return `
OCT ANALYSIS REPORT
==================

PATIENT INFORMATION:
- Patient ID: ${result.patientId}
- Analysis ID: ${result.id}
- Analysis Date: ${new Date(result.timestamp).toLocaleDateString('th-TH')}
- Analysis Time: ${new Date(result.timestamp).toLocaleTimeString('th-TH')}

ANALYSIS RESULTS:
- Status: ${result.hasDetection ? 'CNV DETECTED' : 'NORMAL'}
- Confidence Level: ${result.confidence.toFixed(1)}%
- Risk Assessment: ${result.riskLevel}
${result.detectedDisease ? `- Detected Condition: ${result.detectedDisease}` : ''}

CONFIDENCE INTERPRETATION:
${result.confidence > 90 ? 'High Confidence (>90%) - Results are highly reliable' : 
  result.confidence > 70 ? 'Medium Confidence (70-90%) - Results are moderately reliable' : 
  'Low Confidence (<70%) - Results require additional verification'}

CLINICAL SUMMARY:
${result.hasDetection ? result.detectedDisease + ' detected' : 'No abnormalities detected'} with ${result.confidence.toFixed(1)}% confidence.

RECOMMENDATIONS:
${result.hasDetection && result.confidence > 85 ? '- URGENT: Immediate referral to retina specialist' : 
  result.hasDetection ? '- Further evaluation by ophthalmologist recommended' : 
  '- Continue routine eye examinations'}
${result.detectedDisease && result.detectedDisease.includes('CNV') ? '- Consider anti-VEGF injection therapy' : ''}
- Follow institutional protocols for patient care
- Document findings in patient medical record

TECHNICAL DETAILS:
- AI Model: OCT Analysis System v1.0
- Processing Method: Deep Learning CNN
- Image Quality: Acceptable for analysis
- Analysis Duration: ~2-3 seconds

DISCLAIMER:
This AI-generated report is intended to assist healthcare professionals 
in clinical decision-making. Final diagnosis and treatment decisions 
should always be made by qualified medical practitioners based on 
comprehensive clinical evaluation.

Generated by OCT Analysis System
Report Date: ${new Date().toLocaleString('th-TH')}
            `.trim();
        }

        function newAnalysis() {
            // Reset to ready state - show upload section and patient form
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('patientInfoForm').style.display = 'block';
            document.getElementById('analysisProgress').style.display = 'none';
            document.getElementById('analysisResults').style.display = 'none';
            document.getElementById('fileInput').value = '';
            document.getElementById('patientId').value = '';
            document.getElementById('eyeSide').value = '';
            document.getElementById('examDate').value = '';
            currentAnalysis = null;
        }

        function analyseMore() {
            // Same as newAnalysis - reset to upload state and show patient form
            newAnalysis();
        }

        // Offline Analysis Queue
        let offlineAnalysisQueue = JSON.parse(localStorage.getItem('offlineAnalysisQueue') || '[]');

        function queueOfflineAnalysis(analysisData) {
            offlineAnalysisQueue.push({
                ...analysisData,
                queuedAt: new Date().toISOString(),
                status: 'queued'
            });
            localStorage.setItem('offlineAnalysisQueue', JSON.stringify(offlineAnalysisQueue));
            
            // Register background sync if available
            if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
                navigator.serviceWorker.ready.then((registration) => {
                    return registration.sync.register('background-sync-analysis');
                });
            }
        }

        function processOfflineQueue() {
            if (navigator.onLine && offlineAnalysisQueue.length > 0) {
                console.log('Processing offline analysis queue...');
                // Process queued analyses
                offlineAnalysisQueue.forEach((queuedAnalysis, index) => {
                    if (queuedAnalysis.status === 'queued') {
                        // Simulate processing
                        setTimeout(() => {
                            offlineAnalysisQueue[index].status = 'processed';
                            localStorage.setItem('offlineAnalysisQueue', JSON.stringify(offlineAnalysisQueue));
                        }, index * 1000);
                    }
                });
            }
        }

        // Enhanced PWA Features
        function requestNotificationPermission() {
            if ('Notification' in window && navigator.serviceWorker) {
                Notification.requestPermission().then((permission) => {
                    if (permission === 'granted') {
                        console.log('‚úÖ Notification permission granted');
                    }
                });
            }
        }

        function showNotification(title, options = {}) {
            if ('Notification' in window && Notification.permission === 'granted') {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.ready.then((registration) => {
                        registration.showNotification(title, {
                            body: options.body || 'OCT Analysis System',
                            icon: generateIcon(192),
                            badge: generateIcon(72),
                            vibrate: [200, 100, 200],
                            data: options.data || {},
                            actions: options.actions || [],
                            ...options
                        });
                    });
                } else {
                    new Notification(title, {
                        body: options.body || 'OCT Analysis System',
                        icon: generateIcon(192),
                        ...options
                    });
                }
            }
        }

        // Enhanced offline detection
        function updateOnlineStatus() {
            const indicator = document.getElementById('offlineIndicator');
            if (navigator.onLine) {
                indicator.style.display = 'none';
                processOfflineQueue();
            } else {
                indicator.style.display = 'block';
                indicator.textContent = 'üî¥ ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ';
                indicator.className = 'offline-indicator';
            }
        }

        // Enhanced analysis function with offline support
        function completeAnalysisWithOfflineSupport(patientId, eyeSide, examDate) {
            const analysisData = {
                patientId,
                eyeSide,
                examDate,
                imageData: currentAnalysis ? currentAnalysis.imageData : null
            };

            if (!navigator.onLine) {
                // Queue for offline processing
                queueOfflineAnalysis(analysisData);
                
                // Show offline message
                document.getElementById('analysisProgress').style.display = 'none';
                document.getElementById('analysisResults').innerHTML = `
                    <div class="card" style="text-align: center; padding: 3rem;">
                        <h3>üì± ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÇ‡∏´‡∏°‡∏î</h3>
                        <p style="margin: 1.5rem 0;">‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß</p>
                        <p style="color: rgba(255,255,255,0.8);">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                        <button onclick="newAnalysis()" class="btn" style="margin-top: 2rem;">
                            üîÑ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>
                `;
                document.getElementById('analysisResults').style.display = 'block';
                return;
            }

            // Online processing
            completeAnalysis(patientId, eyeSide, examDate);
        }

        // App shortcuts handling
        function handleAppShortcuts() {
            const urlParams = new URLSearchParams(window.location.search);
            const page = urlParams.get('page');
            
            if (page && document.getElementById('mainApp').classList.contains('active')) {
                // Auto-login for shortcuts (in real app, you'd check auth state)
                setTimeout(() => {
                    if (page === 'newAnalysis') {
                        showPage('newAnalysis');
                    } else if (page === 'patientHistory') {
                        showPage('patientHistory');
                    }
                }, 100);
            }
        }

        // Enhanced install prompt
        function enhancedInstallPrompt() {
            const installBtn = document.getElementById('installBtn');
            
            // Show install button with better messaging
            if (deferredPrompt) {
                installBtn.innerHTML = 'üì± ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ OCT Analysis';
                installBtn.style.display = 'block';
                
                // Auto-show install prompt after user interaction
                let userInteracted = false;
                document.addEventListener('click', () => {
                    if (!userInteracted && deferredPrompt) {
                        userInteracted = true;
                        setTimeout(() => {
                            if (deferredPrompt) {
                                showInstallBanner();
                            }
                        }, 5000); // Show after 5 seconds of interaction
                    }
                }, { once: true });
            }
        }

        function showInstallBanner() {
            const banner = document.createElement('div');
            banner.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 20px;
                right: 20px;
                background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                color: white;
                padding: 1rem;
                border-radius: 16px;
                box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: space-between;
                animation: slideUp 0.4s ease;
            `;
            
            banner.innerHTML = `
                <div>
                    <strong>üì± ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á OCT Analysis</strong><br>
                    <small>‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å</small>
                </div>
                <div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 0.5rem; border-radius: 8px; margin-right: 0.5rem; cursor: pointer;">‡∏õ‡∏¥‡∏î</button>
                    <button onclick="document.getElementById('installBtn').click(); this.parentElement.parentElement.remove();" style="background: rgba(255,255,255,0.9); border: none; color: #1d4ed8; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer;">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</button>
                </div>
            `;
            
            document.body.appendChild(banner);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (banner.parentElement) {
                    banner.remove();
                }
            }, 10000);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Setup PWA
            setupPWA();
            registerServiceWorker();
            requestNotificationPermission();
            
            updateOnlineStatus();
            handleAppShortcuts();
            enhancedInstallPrompt();
            
            // Add sample data if no history exists
            if (analysisHistory.length === 0) {
                const sampleData = [
                    {
                        id: generateUUID(),
                        patientId: 'P12345',
                        eyeSide: 'OD',
                        examDate: new Date(Date.now() - 86400000).toISOString().split('T')[0],
                        timestamp: new Date(Date.now() - 86400000).toISOString(), // 1 day ago
                        hasDetection: true,
                        confidence: 92.5,
                        detectedDisease: 'Choroidal Neovascularization (CNV)',
                        riskLevel: 'High Risk',
                        imageData: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzMzMzMzMyIvPjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+T0NUIEltYWdlPC90ZXh0Pjwvc3ZnPg==',
                        fileName: 'oct_sample_1.jpg'
                    },
                    {
                        id: generateUUID(),
                        patientId: 'P67890',
                        eyeSide: 'OS',
                        examDate: new Date(Date.now() - 172800000).toISOString().split('T')[0],
                        timestamp: new Date(Date.now() - 172800000).toISOString(), // 2 days ago
                        hasDetection: false,
                        confidence: 87.3,
                        detectedDisease: null,
                        riskLevel: 'Low Risk',
                        imageData: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzMzMzMzMyIvPjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+T0NUIEltYWdlPC90ZXh0Pjwvc3ZnPg==',
                        fileName: 'oct_sample_2.jpg'
                    },
                    {
                        id: generateUUID(),
                        patientId: 'P11111',
                        eyeSide: 'OD',
                        examDate: new Date(Date.now() - 259200000).toISOString().split('T')[0],
                        timestamp: new Date(Date.now() - 259200000).toISOString(), // 3 days ago
                        hasDetection: true,
                        confidence: 78.9,
                        detectedDisease: 'Diabetic Macular Edema',
                        riskLevel: 'Medium Risk',
                        imageData: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzMzMzMzMyIvPjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+T0NUIEltYWdlPC90ZXh0Pjwvc3ZnPg==',
                        fileName: 'oct_sample_3.jpg'
                    }
                ];
                
                analysisHistory = sampleData;
                localStorage.setItem('octAnalysisHistory', JSON.stringify(analysisHistory));
            }
            
            // Load saved data
            updateDashboard();

            // Close modal when clicking outside
            if (document.getElementById('confirmModal')) {
                document.getElementById('confirmModal').addEventListener('click', function(e) {
                    if (e.target === this) {
                        hideConfirmModal();
                    }
                });
            }

            if (document.getElementById('analysisConfirmModal')) {
                document.getElementById('analysisConfirmModal').addEventListener('click', function(e) {
                    if (e.target === this) {
                        hideAnalysisConfirmModal();
                    }
                });
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'966ed2ca62887993',t:'MTc1MzgxNTI1MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
